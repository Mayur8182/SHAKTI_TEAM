<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire Department Admin</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #0d47a1;
            --success-color: #2e7d32;
            --warning-color: #f57f17;
            --danger-color: #c62828;
            --light-bg: #f5f5f5;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            padding-top: 56px;
        }

        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: var(--card-shadow);
        }

        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            background: var(--primary-color);
        }

        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: 1rem;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.85) !important;
            padding: 0.8rem 1.5rem;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--secondary-color);
            color: white !important;
            border-left-color: #fff;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--hover-shadow);
        }

        .stats-card {
            min-height: 140px;
        }

        .badge {
            padding: 0.5em 1em;
            border-radius: 20px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .badge-pending { background-color: var(--warning-color); color: white; }
        .badge-approved { background-color: var(--success-color); color: white; }
        .badge-rejected { background-color: var(--danger-color); color: white; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            background: white;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>


    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-none d-md-block sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_profile') }}">
                                <i class="fas fa-user-circle"></i> My Profile
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{{ url_for('admin_dashboard') }}">
                                <i class="fas fa-home"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('user_activities') }}">
                                <i class="fas fa-history"></i> User Activities
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('manage_applications') }}">
                                <i class="fas fa-file-alt"></i> Applications
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('manage_users') }}">
                                <i class="fas fa-users"></i> Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" onclick="adminDashboard.showInspections()">
                                <i class="fas fa-clipboard-check"></i> Inspections
                            </a>
                        </li>
                        <!-- Instead of using inspection_reports endpoint -->
                        <li class="nav-item">
                            <a href="{{ url_for('inspection_reports') }}" class="nav-link">
                                <i class="fas fa-file-alt"></i>
                                <span>Inspection Reports</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" onclick="showSection('licenses'); loadLicenses();" class="nav-link">
                                <i class="fas fa-certificate"></i> License Management
                            </a>
                        </li>
                        <li class="nav-item text-nowrap">
                            <a class="nav-link" href="/logout">Sign out</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
                <div id="dashboard">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-sm btn-outline-secondary" onclick="adminDashboard.refreshData()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="card text-white bg-primary stats-card">
                                <div class="card-body">
                                    <h5 class="card-title">Total Applications</h5>
                                    <h2 id="total-applications">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-warning stats-card">
                                <div class="card-body">
                                    <h5 class="card-title">Pending</h5>
                                    <h2 id="pending-applications">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-success stats-card">
                                <div class="card-body">
                                    <h5 class="card-title">Approved</h5>
                                    <h2 id="approved-applications">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-white bg-danger stats-card">
                                <div class="card-body">
                                    <h5 class="card-title">Rejected</h5>
                                    <h2 id="rejected-applications">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Latest Applications</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Business Name</th>
                                            <th>Status</th>
                                            <th>Submission Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="latest-applications"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Approved Application Reports</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Report ID</th>
                                            <th>Business Name</th>
                                            <th>Approval Date</th>
                                            <th>Valid Until</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="approved-reports"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">User Profile</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    <div class="position-relative mb-3">
                                        <img id="adminProfileImage" 
                                             src="/static/default-profile.png" 
                                             alt="Admin Profile" 
                                             class="rounded-circle img-thumbnail"
                                             style="width: 150px; height: 150px; object-fit: cover;">
                                        <label for="profileImageUpload" class="position-absolute bottom-0 end-0 bg-white rounded-circle p-2 shadow-sm" style="cursor: pointer;">
                                            <i class="fas fa-camera text-primary"></i>
                                        </label>
                                        <input type="file" id="profileImageUpload" class="d-none" accept="image/*">
                                    </div>
                                    <h4 id="adminName" class="mb-2">Admin Name</h4>
                                    <span id="adminRole" class="badge badge-primary">Administrator</span>
                                </div>
                                <div class="col-md-9">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6 class="text-muted">Contact Information</h6>
                                            <div class="mb-2">
                                                <i class="fas fa-envelope text-primary me-2"></i>
                                                <span id="adminEmail">admin@example.com</span>
                                            </div>
                                            <div class="mb-2">
                                                <i class="fas fa-phone text-primary me-2"></i>
                                                <span id="adminPhone">+1234567890</span>
                                            </div>
                                            <div class="mb-2">
                                                <i class="fas fa-clock text-primary me-2"></i>
                                                <span id="adminLastLogin">Last login: 2024-03-14 10:30 AM</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-muted">Account Statistics</h6>
                                            <div class="mb-2">
                                                <i class="fas fa-users text-primary me-2"></i>
                                                <span id="totalUsers">Total Users: 0</span>
                                            </div>
                                            <div class="mb-2">
                                                <i class="fas fa-file-alt text-primary me-2"></i>
                                                <span id="totalApplications">Total Applications: 0</span>
                                            </div>
                                            <div class="mb-2">
                                                <i class="fas fa-check-circle text-primary me-2"></i>
                                                <span id="totalApprovals">Total Approvals: 0</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-outline-primary" onclick="editAdminProfile()">
                                            <i class="fas fa-edit me-2"></i>Edit Profile
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="applicationDetails"></div>
                
                <!-- Add this after the existing sections in main content -->
                <div id="inspections-section" class="section-content hidden">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Inspection Management</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-primary" onclick="adminDashboard.showScheduleInspection()">
                                <i class="fas fa-plus"></i> Schedule New Inspection
                            </button>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Pending Inspections</h5>
                                    <h2 id="pending-inspections-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Completed Inspections</h5>
                                    <h2 id="completed-inspections-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Today's Inspections</h5>
                                    <h2 id="today-inspections-count">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Inspection Schedule</h5>
                                <div>
                                    <input type="date" id="inspection-date-filter" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="inspections-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Business Name</th>
                                            <th>Location</th>
                                            <th>Inspector</th>
                                            <th>Status</th>
                                            <th>Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- License Management Section -->
                <section id="licenses" class="section-content animated hidden">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">License Management</h2>
                                <div class="flex space-x-4">
                                    <button onclick="showAddLicenseModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                                        <i class="fas fa-plus mr-2"></i>New License
                                    </button>
                                    <button onclick="exportLicenses()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center">
                                        <i class="fas fa-file-export mr-2"></i>Export
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Search and Filter -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div>
                                    <input type="text" id="licenseSearch" placeholder="Search licenses..." 
                                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <select id="statusFilter" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">All Statuses</option>
                                        <option value="active">Active</option>
                                        <option value="expired">Expired</option>
                                        <option value="expiring">Expiring Soon</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="sortBy" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="issue_date">Sort by Issue Date</option>
                                        <option value="expiry_date">Sort by Expiry Date</option>
                                        <option value="business_name">Sort by Business Name</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- License Statistics Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                            <div class="bg-blue-50 p-4 rounded-lg cursor-pointer hover:shadow-md transition-shadow duration-200"
                                 onclick="filterByStatus('all')">
                                <h3 class="text-lg font-semibold text-blue-800">Total Licenses</h3>
                                <p id="totalLicenses" class="text-2xl font-bold text-blue-600">0</p>
                                <p class="text-sm text-blue-600 mt-2">View all licenses</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg cursor-pointer hover:shadow-md transition-shadow duration-200"
                                 onclick="filterByStatus('active')">
                                <h3 class="text-lg font-semibold text-green-800">Active Licenses</h3>
                                <p id="activeLicenses" class="text-2xl font-bold text-green-600">0</p>
                                <p class="text-sm text-green-600 mt-2">View active licenses</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg cursor-pointer hover:shadow-md transition-shadow duration-200"
                                 onclick="filterByStatus('expiring')">
                                <h3 class="text-lg font-semibold text-yellow-800">Expiring Soon</h3>
                                <p id="expiringLicenses" class="text-2xl font-bold text-yellow-600">0</p>
                                <p class="text-sm text-yellow-600 mt-2">Expires within 30 days</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg cursor-pointer hover:shadow-md transition-shadow duration-200"
                                 onclick="filterByStatus('expired')">
                                <h3 class="text-lg font-semibold text-red-800">Expired Licenses</h3>
                                <p id="expiredLicenses" class="text-2xl font-bold text-red-600">0</p>
                                <p class="text-sm text-red-600 mt-2">View expired licenses</p>
                            </div>
                        </div>

                        <!-- License Table with Loading State -->
                        <div id="licenseTableContainer" class="relative">
                            <div id="tableLoadingSpinner" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License No.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Business Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="licensesTableBody" class="divide-y divide-gray-200">
                                        <!-- Licenses will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Add License Modal -->
                <div id="addLicenseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">Add New License</h3>
                            <button onclick="closeAddLicenseModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="addLicenseForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- User Selection -->
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Select User</label>
                                    <div class="relative">
                                        <select id="userId" name="userId" required 
                                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                            <option value="">Select a user</option>
                                        </select>
                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <i class="fas fa-chevron-down"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Business Selection -->
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Business</label>
                                    <div class="relative">
                                        <select id="businessSelect" name="businessSelect" required 
                                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                            <option value="">Select a business</option>
                                        </select>
                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <i class="fas fa-chevron-down"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Business Details (Auto-filled from selection) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Business Name</label>
                                    <input type="text" id="businessName" name="businessName" readonly
                                           class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Business Address</label>
                                    <input type="text" id="businessAddress" name="businessAddress" readonly
                                           class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                                    <input type="text" id="contactPerson" name="contactPerson" readonly
                                           class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                                    <input type="tel" id="contactNumber" name="contactNumber" readonly
                                           class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                                </div>

                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="email" name="email" readonly
                                           class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                                </div>
                            </div>

                            <div class="flex justify-end space-x-4 pt-6">
                                <button type="button" onclick="closeAddLicenseModal()" 
                                        class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="px-6 py-2 border border-transparent rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Generate License
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <script>
                    let users = [];
                    let businesses = [];

                    async function loadUsers() {
                        try {
                            const response = await fetch('/api/users');
                            const data = await response.json();
                            users = data.users;
                            
                            const userSelect = document.getElementById('userId');
                            userSelect.innerHTML = '<option value="">Select a user</option>';
                            
                            users.forEach(user => {
                                const option = document.createElement('option');
                                option.value = user._id;
                                option.textContent = `${user.name} (${user.email})`;
                                userSelect.appendChild(option);
                            });
                        } catch (error) {
                            console.error('Error loading users:', error);
                            showNotification('Failed to load users', 'error');
                        }
                    }

                    async function loadBusinesses(userId) {
                        try {
                            const response = await fetch(`/api/businesses/${userId}`);
                            const data = await response.json();
                            businesses = data.businesses;
                            
                            const businessSelect = document.getElementById('businessSelect');
                            businessSelect.innerHTML = '<option value="">Select a business</option>';
                            
                            businesses.forEach(business => {
                                const option = document.createElement('option');
                                option.value = business._id;
                                option.textContent = business.business_name;
                                businessSelect.appendChild(option);
                            });
                        } catch (error) {
                            console.error('Error loading businesses:', error);
                            showNotification('Failed to load businesses', 'error');
                        }
                    }

                    function showAddLicenseModal() {
                        document.getElementById('addLicenseModal').classList.remove('hidden');
                        document.getElementById('addLicenseModal').classList.add('flex');
                        loadUsers();
                    }

                    function closeAddLicenseModal() {
                        document.getElementById('addLicenseModal').classList.add('hidden');
                        document.getElementById('addLicenseModal').classList.remove('flex');
                        document.getElementById('addLicenseForm').reset();
                        clearBusinessDetails();
                    }

                    function clearBusinessDetails() {
                        document.getElementById('businessName').value = '';
                        document.getElementById('businessAddress').value = '';
                        document.getElementById('contactPerson').value = '';
                        document.getElementById('contactNumber').value = '';
                        document.getElementById('email').value = '';
                    }

                    // Event Listeners
                    document.getElementById('userId').addEventListener('change', (e) => {
                        const userId = e.target.value;
                        if (userId) {
                            loadBusinesses(userId);
                        } else {
                            document.getElementById('businessSelect').innerHTML = '<option value="">Select a business</option>';
                            clearBusinessDetails();
                        }
                    });

                    document.getElementById('businessSelect').addEventListener('change', (e) => {
                        const businessId = e.target.value;
                        const business = businesses.find(b => b._id === businessId);
                        
                        if (business) {
                            document.getElementById('businessName').value = business.business_name;
                            document.getElementById('businessAddress').value = business.business_address;
                            document.getElementById('contactPerson').value = business.contact_person;
                            document.getElementById('contactNumber').value = business.contact_number;
                            document.getElementById('email').value = business.email;
                        } else {
                            clearBusinessDetails();
                        }
                    });

                    document.getElementById('addLicenseForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const formData = {
                            userId: document.getElementById('userId').value,
                            businessId: document.getElementById('businessSelect').value,
                            businessName: document.getElementById('businessName').value,
                            businessAddress: document.getElementById('businessAddress').value,
                            contactPerson: document.getElementById('contactPerson').value,
                            contactNumber: document.getElementById('contactNumber').value,
                            email: document.getElementById('email').value
                        };
                        
                        try {
                            const response = await fetch('/api/licenses/create', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(formData)
                            });
                            
                            const data = await response.json();
                            
                            if (response.ok) {
                                showNotification('License generated successfully', 'success');
                                closeAddLicenseModal();
                                loadLicenses();
                            } else {
                                throw new Error(data.error || 'Failed to generate license');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            showNotification(error.message, 'error');
                        }
                    });
                </script>
            </main>
        </div>
    </div>

    <!-- Admin Profile Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center space-x-4">
            <div class="relative">
                <img id="adminProfileImage" 
                     src="/static/default-profile.png" 
                     alt="Admin Profile" 
                     class="w-24 h-24 rounded-full object-cover">
                <label for="profileImageInput" 
                       class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-2 cursor-pointer">
                    <i class="fas fa-camera"></i>
                    <input type="file" 
                           id="profileImageInput" 
                           accept="image/*" 
                           class="hidden">
                </label>
            </div>
            <div>
                <h2 id="adminName" class="text-2xl font-bold">Admin</h2>
                <p id="adminEmail" class="text-gray-600"></p>
                <p id="adminPhone" class="text-gray-600"></p>
            </div>
        </div>
    </div>

    <!-- Admin Profile Form -->
    <form id="adminProfileForm" class="bg-white rounded-lg shadow-md p-6">
        <div class="grid grid-cols-1 gap-6">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                <input type="text" 
                       name="name" 
                       id="name" 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" 
                       name="email" 
                       id="email" 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                <input type="tel" 
                       name="phone" 
                       id="phone" 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <button type="submit" 
                        class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Update Profile
                </button>
            </div>
        </div>
    </form>

    <script>
        class AdminDashboard {
            constructor() {
                this.currentView = 'dashboard';
                this.socket = io();
                this.setupSocketListeners();
                this.setupEventListeners();
                this.loadDashboard();
            }

            setupSocketListeners() {
                this.socket.on('new_application', (data) => {
                    this.showNotification('New application received!', 'info');
                    this.loadDashboard();
                });

                this.socket.on('application_updated', (data) => {
                    this.showNotification(`Application ${data.applicationId} ${data.status}`, 'success');
                    this.loadDashboard();
                });
            }

            setupEventListeners() {
                document.addEventListener('DOMContentLoaded', () => {
                    this.loadDashboard();
                });
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification bg-${type} text-white`;
                notification.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${message}</span>
                        <button type="button" class="close text-white" onclick="this.parentElement.parentElement.remove()">
                            <span>&times;</span>
                        </button>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }

            async loadDashboard() {
                await Promise.all([
                    this.updateDashboardStats(),
                    this.updateLatestApplications(),
                    this.updateApprovedReports()
                ]);
            }

            async updateDashboardStats() {
                try {
                    const response = await fetch('/api/dashboard-stats');
                    const stats = await response.json();
                    
                    document.getElementById('total-applications').textContent = stats.total;
                    document.getElementById('pending-applications').textContent = stats.pending;
                    document.getElementById('approved-applications').textContent = stats.approved;
                    document.getElementById('rejected-applications').textContent = stats.rejected;
                } catch (error) {
                    console.error('Error fetching dashboard stats:', error);
                    this.showNotification('Error loading dashboard statistics', 'danger');
                }
            }

            async updateApplicationStatus(applicationId, newStatus) {
                try {
                    // Get rejection reason if status is 'rejected'
                    let reason = '';
                    if (newStatus === 'rejected') {
                        reason = prompt('Please provide rejection reason:');
                        if (reason === null) return; // User cancelled the prompt
                    }

                    // Get CSRF token from meta tag
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                    
                    const response = await fetch(`/application/${applicationId}/update-status`, {
                        method: 'POST',
                        credentials: 'same-origin', // Include cookies in the request
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ 
                            status: newStatus,
                            reason: reason,
                            csrf_token: csrfToken // Include token in request body as well
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // Show success notification
                    this.showNotification(`Application ${newStatus} successfully`, 'success');
                    
                    // Refresh the dashboard data
                    await this.loadDashboard();

                    // If we're in details view, refresh it
                    if (this.currentView === 'details') {
                        await this.viewApplication(applicationId);
                    }

                } catch (error) {
                    console.error('Error updating application status:', error);
                    this.showNotification(`Error updating application status: ${error.message}`, 'danger');
                }
            }

            async updateLatestApplications() {
                try {
                    const response = await fetch('/api/latest-applications');
                    const data = await response.json();
                    
                    const tableBody = document.getElementById('latest-applications');
                    tableBody.innerHTML = data.applications.map(app => `
                        <tr>
                            <td>${app.id}</td>
                            <td>${app.business_name}</td>
                            <td><span class="badge badge-${app.status.toLowerCase()}">${app.status}</span></td>
                            <td>${new Date(app.timestamp).toLocaleString()}</td>
                            <td>
                                ${app.status === 'pending' ? `
                                    <button class="btn btn-sm btn-success" onclick="adminDashboard.updateApplicationStatus('${app.id}', 'approved')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="adminDashboard.updateApplicationStatus('${app.id}', 'rejected')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-primary" onclick="adminDashboard.viewApplication('${app.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } catch (error) {
                    console.error('Error fetching latest applications:', error);
                    this.showNotification('Error loading latest applications', 'danger');
                }
            }

            async viewApplication(applicationId) {
                try {
                    const response = await fetch(`/application/${applicationId}`);
                    const application = await response.json();
                    
                    this.currentView = 'details';
                    document.getElementById('dashboard').style.display = 'none';
                    const detailsDiv = document.getElementById('applicationDetails');
                    detailsDiv.style.display = 'block';
                    
                    detailsDiv.innerHTML = `
                        <div class="card">
                            <div class="card-header bg-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0">Application Details</h4>
                                    <div class="action-buttons">
                                        <button class="btn btn-success" onclick="adminDashboard.updateApplicationStatus('${application.id}', 'approved')">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button class="btn btn-danger" onclick="adminDashboard.updateApplicationStatus('${application.id}', 'rejected')">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                        <button class="btn btn-primary" onclick="adminDashboard.showDashboard()">
                                            <i class="fas fa-arrow-left"></i> Back
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Application Details Content -->
                                ${this.generateApplicationDetailsHTML(application)}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error fetching application details:', error);
                    this.showNotification('Error loading application details', 'danger');
                }
            }

            generateApplicationDetailsHTML(application) {
                return `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Business Information</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Business Name</th>
                                    <td>${application.business_name}</td>
                                </tr>
                                <tr>
                                    <th>Business Address</th>
                                    <td>${application.business_address}</td>
                                </tr>
                                <tr>
                                    <th>Contact Person</th>
                                    <td>${application.contact_person}</td>
                                </tr>
                                <tr>
                                    <th>Contact Email</th>
                                    <td>${application.contact_email}</td>
                                </tr>
                                <tr>
                                    <th>Contact Phone</th>
                                    <td>${application.contact_phone}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Application Details</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Application ID</th>
                                    <td>${application.id}</td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td><span class="badge badge-${application.status}">${application.status}</span></td>
                                </tr>
                                <tr>
                                    <th>Submission Date</th>
                                    <td>${new Date(application.timestamp).toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <th>Last Updated</th>
                                    <td>${new Date(application.last_updated).toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Additional Information</h5>
                            <div class="card">
                                <div class="card-body">
                                    <pre class="mb-0">${application.additional_info || 'No additional information provided.'}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${this.generateAttachmentsHTML(application.attachments)}
                `;
            }

            generateAttachmentsHTML(attachments) {
                if (!attachments || attachments.length === 0) {
                    return '<div class="row mt-4"><div class="col-12"><h5>Attachments</h5><p>No attachments provided.</p></div></div>';
                }

                return `
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Attachments</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Filename</th>
                                            <th>Type</th>
                                            <th>Size</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${attachments.map(attachment => `
                                            <tr>
                                                <td>${attachment.filename}</td>
                                                <td>${attachment.type}</td>
                                                <td>${this.formatFileSize(attachment.size)}</td>
                                                <td>
                                                    <a href="/download/${attachment.id}" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-download"></i> Download
                                                    </a>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            formatFileSize(bytes) {
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                if (bytes === 0) return '0 Byte';
                const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
                return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
            }

            showDashboard() {
                this.currentView = 'dashboard';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('applicationDetails').style.display = 'none';
                this.loadDashboard();
            }

            refreshData() {
                this.loadDashboard();
                this.showNotification('Dashboard refreshed', 'info');
            }

            async updateApprovedReports() {
                try {
                    const response = await fetch('/api/approved-reports');
                    const data = await response.json();
                    
                    const tableBody = document.getElementById('approved-reports');
                    tableBody.innerHTML = data.reports.map(report => `
                        <tr>
                            <td>${report.report_id}</td>
                            <td>${report.business_name}</td>
                            <td>${new Date(report.approval_details.approval_date).toLocaleDateString()}</td>
                            <td>${new Date(report.approval_details.valid_until).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="adminDashboard.viewReport('${report.report_id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-success" onclick="adminDashboard.downloadReport('${report.report_id}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } catch (error) {
                    console.error('Error fetching approved reports:', error);
                    this.showNotification('Error loading approved reports', 'danger');
                }
            }

            async viewReport(reportId) {
                try {
                    const response = await fetch(`/approval-report/${reportId}`);
                    const report = await response.json();
                    
                    this.currentView = 'report';
                    document.getElementById('dashboard').style.display = 'none';
                    const detailsDiv = document.getElementById('applicationDetails');
                    detailsDiv.style.display = 'block';
                    
                    detailsDiv.innerHTML = `
                        <div class="card">
                            <div class="card-header bg-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0">NOC Report Details</h4>
                                    <div class="action-buttons">
                                        <button class="btn btn-success" onclick="adminDashboard.downloadReport('${report.report_id}')">
                                            <i class="fas fa-download"></i> Download Report
                                        </button>
                                        <button class="btn btn-primary" onclick="adminDashboard.showDashboard()">
                                            <i class="fas fa-arrow-left"></i> Back
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Business Information</h5>
                                        <table class="table table-bordered">
                                            <tr>
                                                <th>Business Name</th>
                                                <td>${report.business_name}</td>
                                            </tr>
                                            <tr>
                                                <th>Business Type</th>
                                                <td>${report.business_type}</td>
                                            </tr>
                                            <tr>
                                                <th>Business Address</th>
                                                <td>${report.business_address}</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Approval Details</h5>
                                        <table class="table table-bordered">
                                            <tr>
                                                <th>Approved By</th>
                                                <td>${report.approval_details.approved_by}</td>
                                            </tr>
                                            <tr>
                                                <th>Approval Date</th>
                                                <td>${new Date(report.approval_details.approval_date).toLocaleDateString()}</td>
                                            </tr>
                                            <tr>
                                                <th>Valid Until</th>
                                                <td>${new Date(report.approval_details.valid_until).toLocaleDateString()}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h5>Safety Compliance</h5>
                                        <table class="table table-bordered">
                                            <tr>
                                                <th>Fire Extinguishers</th>
                                                <td>${report.safety_compliance.fire_extinguishers}</td>
                                            </tr>
                                            <tr>
                                                <th>Fire Alarm System</th>
                                                <td>${report.safety_compliance.fire_alarm}</td>
                                            </tr>
                                            <tr>
                                                <th>Emergency Exits</th>
                                                <td>${report.safety_compliance.emergency_exits}</td>
                                            </tr>
                                            <tr>
                                                <th>Last Fire Drill</th>
                                                <td>${report.safety_compliance.last_fire_drill}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h5>Approval Conditions</h5>
                                        <ul class="list-group">
                                            ${report.approval_conditions.map(condition => `
                                                <li class="list-group-item">${condition}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error fetching report details:', error);
                    this.showNotification('Error loading report details', 'danger');
                }
            }

            async downloadReport(reportId) {
                try {
                    window.location.href = `/download-report/${reportId}`;
                } catch (error) {
                    console.error('Error downloading report:', error);
                    this.showNotification('Error downloading report', 'danger');
                }
            }

            showInspections() {
                this.hideAllSections();
                document.getElementById('inspections-section').classList.remove('hidden');
                this.loadInspections();
            }

            async showScheduleInspection() {
                try {
                    const response = await fetch('/api/schedule-inspection-data', {
                        headers: {
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch data');
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load data');
                    }

                    // Populate business select
                    const businessSelect = document.getElementById('business-select');
                    businessSelect.innerHTML = '<option value="">Select Business</option>';
                    data.businesses.forEach(business => {
                        businessSelect.innerHTML += `
                            <option value="${business.id}">${business.name} - ${business.address}</option>
                        `;
                    });

                    // Populate inspector select
                    const inspectorSelect = document.getElementById('inspector-select');
                    inspectorSelect.innerHTML = '<option value="">Select Inspector</option>';
                    data.inspectors.forEach(inspector => {
                        inspectorSelect.innerHTML += `
                            <option value="${inspector.id}">${inspector.name} - ${inspector.email}</option>
                        `;
                    });

                    // Set minimum date to today
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('inspection-date').min = today;

                    // Show modal using Bootstrap 5
                    const modal = new bootstrap.Modal(document.getElementById('scheduleInspectionModal'));
                    modal.show();

                } catch (error) {
                    console.error('Error loading scheduling data:', error);
                    this.showNotification('Error loading scheduling data: ' + error.message, 'danger');
                }
            }

            hideAllSections() {
                document.querySelectorAll('.section-content').forEach(section => {
                    section.classList.add('hidden');
                });
                document.getElementById('dashboard').style.display = 'none';
            }

            async loadInspections() {
                try {
                    const response = await fetch('/api/inspections', {
                        headers: {
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateInspectionCounts(data.inspections);
                        this.updateInspectionsTable(data.inspections);
                    } else {
                        throw new Error(data.error || 'Failed to load inspections');
                    }

                } catch (error) {
                    console.error('Error loading inspections:', error);
                    this.showNotification('Error loading inspections: ' + error.message, 'danger');
                }
            }

            updateInspectionCounts(inspections) {
                const counts = {
                    pending: inspections.filter(i => i.status === 'pending').length,
                    completed: inspections.filter(i => i.status === 'completed').length,
                    today: inspections.filter(i => {
                        const today = new Date().toISOString().split('T')[0];
                        return i.date === today;
                    }).length
                };

                document.getElementById('pending-inspections-count').textContent = counts.pending;
                document.getElementById('completed-inspections-count').textContent = counts.completed;
                document.getElementById('today-inspections-count').textContent = counts.today;
            }

            updateInspectionsTable(inspections) {
                const tbody = document.querySelector('#inspections-table tbody');
                tbody.innerHTML = inspections.map(inspection => `
                    <tr>
                        <td>${inspection.date}</td>
                        <td>${inspection.time}</td>
                        <td>${inspection.business_name}</td>
                        <td>${inspection.location}</td>
                        <td>${inspection.inspector_name}</td>
                        <td>
                            <span class="badge bg-${this.getStatusColor(inspection.status)}">
                                ${inspection.status}
                            </span>
                        </td>
                        <td>${inspection.notes || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="adminDashboard.viewInspection('${inspection._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="adminDashboard.editInspection('${inspection._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            getStatusColor(status) {
                const colors = {
                    'pending': 'warning',
                    'scheduled': 'primary',
                    'completed': 'success',
                    'cancelled': 'danger',
                    'in_progress': 'info'
                };
                return colors[status.toLowerCase()] || 'secondary';
            }

            async viewInspection(id) {
                try {
                    const response = await fetch(`/api/inspection/${id}`, {
                        headers: {
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch inspection details');
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load inspection details');
                    }

                    const inspection = data.inspection;
                    
                    // Create modal HTML
                    const modalHtml = `
                        <div class="modal fade" id="viewInspectionModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Inspection Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Business Information</h6>
                                                <p><strong>Name:</strong> ${inspection.business_name}</p>
                                                <p><strong>Location:</strong> ${inspection.location || 'N/A'}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Schedule Information</h6>
                                                <p><strong>Date:</strong> ${inspection.date}</p>
                                                <p><strong>Time:</strong> ${inspection.time}</p>
                                                <p><strong>Status:</strong> 
                                                    <span class="badge bg-${this.getStatusColor(inspection.status)}">
                                                        ${inspection.status}
                                                    </span>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <h6>Inspector Information</h6>
                                                <p><strong>Name:</strong> ${inspection.inspector_name}</p>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <h6>Notes</h6>
                                                <p>${inspection.notes || 'No notes available'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove existing modal if any
                    const existingModal = document.getElementById('viewInspectionModal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Add new modal to document
                    document.body.insertAdjacentHTML('beforeend', modalHtml);

                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('viewInspectionModal'));
                    modal.show();

                } catch (error) {
                    console.error('Error viewing inspection:', error);
                    this.showNotification('Error loading inspection details: ' + error.message, 'danger');
                }
            }

            async editInspection(id) {
                try {
                    const response = await fetch(`/api/inspection/${id}`, {
                        headers: {
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch inspection details');
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load inspection details');
                    }

                    const inspection = data.inspection;
                    
                    // Create modal HTML
                    const modalHtml = `
                        <div class="modal fade" id="editInspectionModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edit Inspection</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="editInspectionForm">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Date</label>
                                                    <input type="date" class="form-control" id="edit-date" 
                                                        value="${inspection.date}" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Time</label>
                                                    <input type="time" class="form-control" id="edit-time" 
                                                        value="${inspection.time}" required>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Status</label>
                                                <select class="form-select" id="edit-status" required>
                                                    <option value="pending" ${inspection.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                    <option value="scheduled" ${inspection.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                                    <option value="in_progress" ${inspection.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                                    <option value="completed" ${inspection.status === 'completed' ? 'selected' : ''}>Completed</option>
                                                    <option value="cancelled" ${inspection.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Notes</label>
                                                <textarea class="form-control" id="edit-notes" rows="3">${inspection.notes || ''}</textarea>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="adminDashboard.saveInspectionChanges('${id}')">
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove existing modal if any
                    const existingModal = document.getElementById('editInspectionModal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Add new modal to document
                    document.body.insertAdjacentHTML('beforeend', modalHtml);

                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('editInspectionModal'));
                    modal.show();

                } catch (error) {
                    console.error('Error editing inspection:', error);
                    this.showNotification('Error loading inspection details: ' + error.message, 'danger');
                }
            }

            async saveInspectionChanges(id) {
                try {
                    const formData = {
                        date: document.getElementById('edit-date').value,
                        time: document.getElementById('edit-time').value,
                        status: document.getElementById('edit-status').value,
                        notes: document.getElementById('edit-notes').value
                    };

                    const response = await fetch(`/api/inspection/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update inspection');
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showNotification('Inspection updated successfully', 'success');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editInspectionModal'));
                        modal.hide();
                        this.loadInspections();
                    } else {
                        throw new Error(data.error || 'Failed to update inspection');
                    }

                } catch (error) {
                    console.error('Error saving inspection changes:', error);
                    this.showNotification('Error updating inspection: ' + error.message, 'danger');
                }
            }

            async updateInspectionStatus(inspectionId, newStatus) {
                try {
                    const response = await fetch(`/api/inspection/${inspectionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    const data = await response.json();
                    if (data.success) {
                        this.showNotification('Status updated successfully', 'success');
                        
                        // If status is changed to completed, trigger report generation
                        if (newStatus === 'completed') {
                            await this.generateInspectionReport(inspectionId);
                        }
                        
                        // Refresh the inspections table
                        this.loadInspections();
                    } else {
                        this.showNotification(data.error || 'Failed to update status', 'error');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    this.showNotification('Failed to update status', 'error');
                }
            }

            async generateInspectionReport(inspectionId) {
                try {
                    const reportData = {
                        inspection_id: inspectionId,
                        report_data: {
                            findings: [],
                            recommendations: [],
                            compliance_status: 'compliant'
                        }
                    };

                    const response = await fetch(`/api/inspection/${inspectionId}/complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        },
                        body: JSON.stringify(reportData)
                    });

                    const data = await response.json();
                    if (data.success) {
                        this.showNotification('Inspection report generated successfully', 'success');
                        if (data.report_url) {
                            window.open(data.report_url, '_blank');
                        }
                    } else {
                        this.showNotification(data.error || 'Failed to generate report', 'error');
                    }
                } catch (error) {
                    console.error('Error generating report:', error);
                    this.showNotification('Failed to generate report', 'error');
                }
            }

            async submitInspectionReport() {
                try {
                    const form = document.getElementById('inspectionReportForm');
                    const formData = new FormData(form);
                    const reportData = {
                        fire_safety: {
                            fire_extinguishers: formData.get('fire_extinguishers'),
                            fire_alarm: formData.get('fire_alarm')
                        },
                        emergency_systems: {
                            emergency_exits: formData.get('emergency_exits'),
                            emergency_lighting: formData.get('emergency_lighting')
                        },
                        notes: formData.get('notes')
                    };

                    const response = await fetch(`/api/inspection/${this.currentInspectionId}/complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        },
                        body: JSON.stringify({
                            inspection_id: this.currentInspectionId,
                            report_data: reportData
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to complete inspection');
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showNotification('Inspection completed and report generated', 'success');
                        
                        // Download the report
                        window.location.href = data.report_url;
                        
                        // Close modal and refresh
                        const modal = bootstrap.Modal.getInstance(document.getElementById('completeInspectionModal'));
                        modal.hide();
                        this.loadInspections();
                    } else {
                        throw new Error(data.error || 'Failed to complete inspection');
                    }

                } catch (error) {
                    console.error('Error completing inspection:', error);
                    this.showNotification('Error completing inspection: ' + error.message, 'danger');
                }
            }
        }

        // Initialize the dashboard
        const adminDashboard = new AdminDashboard();

        async function loadAdminProfile() {
            try {
                const response = await fetch('/api/admin-profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    // Update profile information
                    document.getElementById('adminName').textContent = data.name || 'Admin';
                    document.getElementById('adminEmail').textContent = data.email || '';
                    document.getElementById('adminPhone').textContent = data.phone || '';
                    
                    // Update profile image with error handling
                    const profileImg = document.getElementById('adminProfileImage');
                    if (profileImg) {
                        profileImg.onerror = function() {
                            this.src = '/static/images/default-profile.png';
                        };
                        profileImg.src = data.profile_image.startsWith('/') ? 
                            data.profile_image : 
                            `/static/profile_images/${data.profile_image}`;
                    }
                } else {
                    console.error('Failed to load admin profile:', data.error);
                    adminDashboard.showNotification('Failed to load profile information', 'error');
                }
            } catch (error) {
                console.error('Error loading admin profile:', error);
                adminDashboard.showNotification('Error loading profile information', 'error');
                
                // Set default values on error
                document.getElementById('adminName').textContent = 'Admin';
                document.getElementById('adminEmail').textContent = '';
                document.getElementById('adminPhone').textContent = '';
                const profileImg = document.getElementById('adminProfileImage');
                if (profileImg) {
                    profileImg.src = '/static/images/default-profile.png';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAdminProfile();
            
            const profileImageUpload = document.getElementById('profileImageUpload');
            if (profileImageUpload) {
                profileImageUpload.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    try {
                        const formData = new FormData();
                        formData.append('profile_image', file);
                        
                        const response = await fetch('/api/admin/profile/image', {
                            method: 'POST',
                            headers: {
                                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                            },
                            body: formData
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            adminDashboard.showNotification('Profile image updated successfully', 'success');
                            loadAdminProfile();
                        } else {
                            throw new Error(data.error || 'Failed to update profile image');
                        }
                    } catch (error) {
                        console.error('Error updating profile image:', error);
                        adminDashboard.showNotification('Failed to update profile image', 'error');
                    }
                });
            }
        });
    </script>
    <script>
        // Function to show notifications
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} fixed top-4 right-4 z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Function to load admin profile
        async function loadAdminProfile() {
            try {
                const response = await fetch('/api/admin/profile');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.success) {
                    // Update profile information
                    document.getElementById('adminName').textContent = data.name || 'Admin';
                    document.getElementById('adminEmail').textContent = data.email || '';
                    document.getElementById('adminPhone').textContent = data.phone || '';
                    
                    // Update profile image if exists
                    if (data.profile_image) {
                        document.getElementById('adminProfileImage').src = `/static/profile_images/${data.profile_image}`;
                    }
                } else {
                    throw new Error(data.error || 'Failed to load profile');
                }
            } catch (error) {
                console.error('Error loading admin profile:', error);
                showNotification('Failed to load profile data', 'error');
            }
        }

        // Function to update admin profile
        async function updateAdminProfile(event) {
            event.preventDefault();
            
            try {
                const formData = new FormData(event.target);
                const response = await fetch('/api/admin/profile/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        email: formData.get('email'),
                        phone: formData.get('phone')
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification('Profile updated successfully');
                    loadAdminProfile(); // Reload profile data
                } else {
                    throw new Error(data.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Failed to update profile', 'error');
            }
        }

        // Function to update profile image
        async function updateProfileImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('profile_image', file);

            try {
                const response = await fetch('/api/admin/profile/update_image', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('adminProfileImage').src = `/static/profile_images/${data.image_path}`;
                    showNotification('Profile image updated successfully');
                } else {
                    throw new Error(data.error || 'Failed to update profile image');
                }
            } catch (error) {
                console.error('Error updating profile image:', error);
                showNotification('Failed to update profile image', 'error');
            }
        }

        // Add event listeners when document loads
        document.addEventListener('DOMContentLoaded', () => {
            loadAdminProfile();
            
            // Add event listener for profile form submission
            const profileForm = document.getElementById('adminProfileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', updateAdminProfile);
            }
            
            // Add event listener for profile image upload
            const imageInput = document.getElementById('profileImageInput');
            if (imageInput) {
                imageInput.addEventListener('change', updateProfileImage);
            }
        });
    </script>
    <!-- Add this at the end of the body -->
    <div class="modal fade" id="scheduleInspectionModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Schedule New Inspection</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="scheduleInspectionForm">
                        <div class="form-group mb-3">
                            <label>Business</label>
                            <select class="form-control" id="business-select" required>
                                <option value="">Select Business</option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label>Inspector</label>
                            <select class="form-control" id="inspector-select" required>
                                <option value="">Select Inspector</option>
                            </select>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="inspection-date" required>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label>Time</label>
                            <input type="time" class="form-control" id="inspection-time" required>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label>Notes</label>
                            <textarea class="form-control" id="inspection-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="adminDashboard.saveInspection()">
                        Schedule Inspection
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add this modal after your existing modals -->
    <div class="modal fade" id="completeInspectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Inspection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="inspectionReportForm">
                        <div class="mb-3">
                            <h6>Fire Safety Equipment</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Fire Extinguishers</label>
                                    <select class="form-select" name="fire_extinguishers" required>
                                        <option value="">Select Status</option>
                                        <option value="pass">Pass</option>
                                        <option value="fail">Fail</option>
                                        <option value="na">N/A</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fire Alarm System</label>
                                    <select class="form-select" name="fire_alarm" required>
                                        <option value="">Select Status</option>
                                        <option value="pass">Pass</option>
                                        <option value="fail">Fail</option>
                                        <option value="na">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Emergency Systems</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Emergency Exits</label>
                                    <select class="form-select" name="emergency_exits" required>
                                        <option value="">Select Status</option>
                                        <option value="pass">Pass</option>
                                        <option value="fail">Fail</option>
                                        <option value="na">N/A</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Emergency Lighting</label>
                                    <select class="form-select" name="emergency_lighting" required>
                                        <option value="">Select Status</option>
                                        <option value="pass">Pass</option>
                                        <option value="fail">Fail</option>
                                        <option value="na">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Inspector Notes</label>
                            <textarea class="form-control" name="notes" rows="4"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="adminDashboard.submitInspectionReport()">
                        Complete & Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>
 
</body>
</html>